create_com_situation = {
    if = {
        limit = {
            NOT = {
                exists = scope:journal_entry
            }
        }
        error_log = "CMF: No journal_entry scope defined! This effect needs to be run in the immediate block of a journal entry!"
    }
    else = {
        fix_variable_error = { variable = $side_name_left$ }
        fix_variable_error = { variable = $side_desc_left$ }
        fix_variable_error = { variable = $side_name_right$ }
        fix_variable_error = { variable = $side_desc_right$ }

        create_struct = {
            struct_type = com_struct_situation
            struct_scope = com_situation
        }
        create_struct = {
            struct_type = com_struct_situation_side
            struct_scope = com_side_left
        }
        create_struct = {
            struct_type = com_struct_situation_side
            struct_scope = com_side_right
        }

        # Create Situation
        scope:journal_entry = {
            set_variable = {
                name = com_situation
                value = scope:com_situation
            }
        }

        # Create Sides
        scope:com_situation = {
            set_variable = {
                name = com_side_left
                value = scope:com_side_left
            }
            set_variable = {
                name = com_side_right
                value = scope:com_side_right
            }
        }
        scope:com_side_left = {
            set_variable = {
                name = com_name
                value = flag:$side_name_left$
            }
            set_variable = {
                name = com_desc
                value = flag:$side_desc_left$
            }
            set_variable = {
                name = com_leader
                value = $side_leader_country_left$
            }
        }
        scope:com_side_right = {
            set_variable = {
                name = com_name
                value = flag:$side_name_right$
            }
            set_variable = {
                name = com_desc
                value = flag:$side_desc_right$
            }
            set_variable = {
                name = com_leader
                value = $side_leader_country_right$
            }
        }
    }
}

set_com_situation_header = {
    fix_variable_error = { variable = $text$ }
    scope:com_situation = {
        set_variable = {
            name = com_header
            value = flag:$text$
        }
    }
}

remove_com_situation_header = {
    scope:com_situation = {
        remove_variable = com_header
    }
}

change_com_situation_leader = {
    scope:com_side_$side$ = {
        set_variable = {
            name = com_leader
            value = $leader$
        }
    }
}

change_com_situation_side_name = {
    fix_variable_error = { variable = $name$ }

    scope:com_side_$side$ = {
        set_variable = {
            name = com_name
            value = flag:$name$
        }
    }
}

change_com_situation_side_description = {
    fix_variable_error = { variable = $desc$ }

    scope:com_side_$side$ = {
        set_variable = {
            name = com_desc
            value = flag:$desc$
        }
    }
}

create_com_situation_faction = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_side_$side$
            }
        }
        error_log = "CMF: No com_side_$side$ scope defined! This effect needs to be run in the immediate block of a journal entry!"
    }
    else = {
        fix_variable_error = { variable = $name$ }
        fix_variable_error = { variable = $desc$ }

        create_struct = {
            struct_type = com_struct_situation_faction
            struct_scope = com_faction_$name$
        }

        # Add name
        scope:com_faction_$name$ = {
            set_variable = {
                name = com_name
                value = flag:$name$
            }
            set_variable = {
                name = com_desc
                value = flag:$desc$
            }
        }

        # Add to defined side
        scope:com_side_$side$ = {
            add_to_variable_list = {
                name = com_factions
                target = scope:com_faction_$name$
            }
        }
    }
}

remove_com_situation_faction = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_side_$side$
            }
        }
        error_log = "CMF: No com_side_$side$ scope defined! This effect needs to be run in the immediate block of a journal entry!"
    }
    else = {
        # Remove faction from list
        scope:com_side_$side$ = {
            remove_list_variable = {
                name = com_factions
                target = scope:com_faction_$name$
            }
        }
        # Cleanup struct
        destroy_struct = {
            struct = com_faction_$name$
        }
    }
}

add_com_situation_faction_country = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_faction_$name$
            }
        }
        error_log = "CMF: No scope:com_faction_$name$ scope defined! This effect needs to be run in the immediate block of a journal entry!"
    }
    else = {
        scope:com_faction_$name$ = {
            add_to_variable_list = {
                name = com_countries
                target = $country$
            }
        }
    }
}

remove_com_situation_faction_country = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_faction_$name$
            }
        }
        error_log = "CMF: No scope:com_faction_$name$ scope defined! This effect needs to be run in the immediate block of a journal entry!"
    }
    else = {
        scope:com_faction_$name$ = {
            remove_list_variable = {
                name = com_countries
                target = $country$
            }
        }
    }
}

create_com_situation_button_group = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! This effect needs to be run in the immediate block of a journal entry!"
    }
    else = {
        fix_variable_error = { variable = $name$ }
        fix_variable_error = { variable = $desc$ }

        create_struct = {
            struct_type = com_struct_situation_button_group
            struct_scope = com_button_group_$name$
        }

        # Add name
        scope:com_button_group_$name$ = {
            set_variable = {
                name = com_name
                value = flag:$name$
            }
            set_variable = {
                name = com_desc
                value = flag:$desc$
            }
        }

        # Add to defined side
        scope:com_situation = {
            add_to_variable_list = {
                name = com_button_groups
                target = scope:com_button_group_$name$
            }
        }
    }
}

remove_com_situation_button_group = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! This effect needs to be run in the immediate block of a journal entry!"
    }
    else = {
        scope:com_situation = {
            remove_list_variable = {
                name = com_button_groups
                target = scope:com_button_group_$name$
            }
        }

        destroy_struct = {
            struct = scope:com_button_group_$name$
        }
    }
}

add_com_situation_button_group_element = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_button_group_$group$
            }
        }
        error_log = "CMF: No com_button_group_$group$ scope defined! This effect needs to be run in the immediate block of a journal entry!"
    }
    else = {
        fix_variable_error = { variable = $name$ }

        scope:com_button_group_$group$ = {
            add_to_variable_list = {
                name = com_buttons
                target = flag:$name$
            }
        }
    }
}

remove_com_situation_button_group_element = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_button_group_$group$
            }
        }
        error_log = "CMF: No com_button_group_$group$ scope defined! This effect needs to be run in the immediate block of a journal entry!"
    }
    else = {
        scope:com_button_group_$group$ = {
            remove_list_variable = {
                name = com_buttons
                target = flag:$name$
            }
        }
    }
}
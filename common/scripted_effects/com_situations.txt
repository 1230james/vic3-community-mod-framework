create_com_situation = {
    if = {
        limit = {
            NOT = {
                exists = scope:journal_entry
            }
        }
        error_log = "CMF: No journal_entry scope defined! This effect should be run in the immediate block of a journal entry!"
    }
    else = {
        fix_variable_error = { variable = $side_name_left$ }
        fix_variable_error = { variable = $side_desc_left$ }
        fix_variable_error = { variable = $side_name_right$ }
        fix_variable_error = { variable = $side_desc_right$ }

        if = {
            limit = {
                any_in_global_list = {
                    variable = com_situation_cache
                    var:com_id ?= $id$
                    has_variable = is_struct
                }
            }
            random_in_global_list = {
                variable = com_situation_cache
                limit = {
                    var:com_id ?= $id$
                    has_variable = is_struct
                }
                save_scope_as = com_situation
            }

            # Setup cached situation
            scope:journal_entry = {
                set_variable = {
                    name = com_situation
                    value = scope:com_situation
                }
            }
        }
        else = {
            create_struct = {
                struct_type = com_struct_situation
                struct_scope = com_situation
            }
            create_struct = {
                struct_type = com_struct_situation_side
                struct_scope = com_side_left
            }
            create_struct = {
                struct_type = com_struct_situation_side
                struct_scope = com_side_right
            }

            # Create Situation
            scope:journal_entry = {
                set_variable = {
                    name = com_situation
                    value = scope:com_situation
                }
            }

            add_to_global_variable_list = {
                name = com_situation_cache
                target = scope:com_situation
            }

            # Create Sides
            scope:com_situation = {
                set_variable = {
                    name = com_id
                    value = $id$
                }
                set_ideology = ideology:$icon$
                set_variable = {
                    name = com_side_left
                    value = scope:com_side_left
                }
                set_variable = {
                    name = com_side_right
                    value = scope:com_side_right
                }
            }
            scope:com_side_left = {
                set_variable = {
                    name = com_name
                    value = flag:$side_name_left$
                }
                set_variable = {
                    name = com_desc
                    value = flag:$side_desc_left$
                }
                set_variable = {
                    name = com_leader
                    value = $side_leader_country_left$
                }
            }
            scope:com_side_right = {
                set_variable = {
                    name = com_name
                    value = flag:$side_name_right$
                }
                set_variable = {
                    name = com_desc
                    value = flag:$side_desc_right$
                }
                set_variable = {
                    name = com_leader
                    value = $side_leader_country_right$
                }
            }
        }
    }
}

set_com_situation_header = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        fix_variable_error = { variable = $text$ }
        scope:com_situation = {
            set_variable = {
                name = com_header
                value = flag:$text$
            }
        }
    }
}

remove_com_situation_header = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        scope:com_situation = {
            remove_variable = com_header
        }
    }
}

change_com_situation_leader = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        scope:com_situation = {
            var:com_side_$side$ = {
                set_variable = {
                    name = com_leader
                    value = $leader$
                }
            }
        }
    }
}

change_com_situation_side_name = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        fix_variable_error = { variable = $name$ }
        scope:com_situation = {
            var:com_side_$side$ = {
                set_variable = {
                    name = com_name
                    value = flag:$name$
                }
            }
        }
    }
}

change_com_situation_side_description = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        fix_variable_error = { variable = $desc$ }
        scope:com_situation = {
            var:com_side_$side$ = {
                set_variable = {
                    name = com_desc
                    value = flag:$desc$
                }
            }
        }
    }
}

create_com_situation_faction = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else_if = {
        limit = {
            scope:com_situation = {
                var:com_side_$side$ = {
                    any_in_list = {
                        variable = com_factions
                        var:com_name ?= flag:$name$
                    }
                }
            }
        }
        debug_log = "CMF: $name$ faction already exists"
    }
    else = {
        fix_variable_error = { variable = $name$ }
        fix_variable_error = { variable = $desc$ }

        create_struct = {
            struct_type = com_struct_situation_faction
            struct_scope = com_faction_$name$
        }

        # Add name
        scope:com_faction_$name$ = {
            set_variable = {
                name = com_name
                value = flag:$name$
            }
            set_variable = {
                name = com_desc
                value = flag:$desc$
            }
        }

        scope:com_situation = {
            var:com_side_$side$ = {
                add_to_variable_list = {
                    name = com_factions
                    target = scope:com_faction_$name$
                }
            }
        }
    }
}

remove_com_situation_faction = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        scope:com_situation = {
            random_in_list = {
                variable = com_factions
                limit = {
                    var:com_name ?= flag:$name$
                }
                save_temporary_scope_as = com_internal_scope
            }
            if = {
                limit = {
                    exists = scope:com_internal_scope
                }
                var:com_side_$side$ = {
                    remove_list_variable = {
                        name = com_factions
                        target = scope:com_internal_scope
                    }
                }
                destroy_struct = {
                    struct = scope:com_internal_scope
                }
            }
        }
    }
}

clear_com_situation_factions = {
    scope:com_situation = {
        var:com_side_$side$ = {
            every_in_list = {
                variable = com_factions
                destroy_struct = {
                    struct = this
                }
            }
            clear_variable_list = com_factions
        }
    }
}

clear_com_situation_factions_both = {
    clear_com_situation_factions = {
        side = left
    }
    clear_com_situation_factions = {
        side = right
    }
}

add_com_situation_faction_country = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        scope:com_situation = {
            var:com_side_$side$ = {
                random_in_list = {
                    variable = com_factions
                    limit = {
                        var:com_name ?= flag:$name$
                    }
                    add_to_variable_list = {
                        name = com_countries
                        target = $country$
                    }
                }
            }
        }
    }
}

remove_com_situation_faction_country = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        scope:com_situation = {
            var:com_side_$side$ = {
                random_in_list = {
                    variable = com_factions
                    limit = {
                        var:com_name ?= flag:$name$
                    }
                    remove_list_variable = {
                        name = com_countries
                        target = $country$
                    }
                }
            }
        }
    }
}

create_com_situation_button_group = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        fix_variable_error = { variable = $name$ }
        fix_variable_error = { variable = $desc$ }

        if = {
            limit = {
                NOT = {
                    scope:com_situation = {
                        any_in_list = {
                            variable = com_button_groups
                            var:com_name ?= flag:$name$
                        }
                    }
                }
            }
            create_struct = {
                struct_type = com_struct_situation_button_group
                struct_scope = com_button_group_$name$
            }

            # Add name
            scope:com_button_group_$name$ = {
                set_variable = {
                    name = com_name
                    value = flag:$name$
                }
                set_variable = {
                    name = com_desc
                    value = flag:$desc$
                }
            }

            # Add to defined side
            scope:com_situation = {
                add_to_variable_list = {
                    name = com_button_groups
                    target = scope:com_button_group_$name$
                }
            }
        }
        else = {
            scope:com_situation = {
                random_in_list = {
                    variable = com_button_groups
                    limit = {
                        var:com_name ?= flag:$name$
                    }
                    save_scope_as = com_button_group_$name$
                }
            }
        }
    }
}

remove_com_situation_button_group = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        scope:com_situation = {
            remove_list_variable = {
                name = com_button_groups
                target = scope:com_button_group_$name$
            }
        }

        destroy_struct = {
            struct = scope:com_button_group_$name$
        }
    }
}

add_com_situation_button_group_element = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        fix_variable_error = { variable = $name$ }
        scope:com_situation = {
            random_in_list = {
                variable = com_button_groups
                limit = {
                    var:com_name ?= flag:$group$
                }
                add_to_variable_list = {
                    name = com_buttons
                    target = flag:$name$
                }
            }
        }
    }
}

remove_com_situation_button_group_element = {
    if = {
        limit = {
            NOT = {
                exists = scope:com_situation
            }
        }
        error_log = "CMF: No com_situation scope defined! Are you in a Journal Entry?"
    }
    else = {
        scope:com_situation = {
            random_in_list = {
                variable = com_button_groups
                limit = {
                    var:com_name ?= flag:$group$
                }
                remove_list_variable = {
                    name = com_buttons
                    target = flag:$name$
                }
            }
        }
    }
}